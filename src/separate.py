import os
import subprocess
import shutil
import torchaudio
import torch

# ==========================================
# Configuration
# ==========================================
# htdemucs: Hybrid Transformer Demucs (Meta's latest & best model)
# v4: Optimized for both quality and speed
MODEL_NAME = "htdemucs"
DEVICE = "cpu"


def separate_audio(file_path, output_dir="temp_stems"):
    """
    Separates audio using Meta's Demucs (SOTA).
    """
    filename = os.path.basename(file_path)
    print(f"üî™ Separating Stems (High Quality - Demucs): {filename}...")

    # 1. Clean previous results if any
    if os.path.exists(output_dir):
        try:
            shutil.rmtree(output_dir)
        except Exception as e:
            print(f"‚ö†Ô∏è Warning clearing temp folder: {e}")

    os.makedirs(output_dir, exist_ok=True)

    # 2. Construct Command
    # demucs -n htdemucs --out [output_dir] [input_file] --device cpu
    cmd = [
        "demucs",
        "-n", MODEL_NAME,
        "--out", output_dir,
        "--device", "cpu",
        file_path
    ]

    print("‚è≥ Running Demucs... (This will take 3-5 mins for High Quality)")

    try:
        # Run the command and wait for it to finish
        subprocess.run(cmd, check=True)
    except subprocess.CalledProcessError as e:
        print(f"‚ùå Demucs Error: {e}")
        return {}
    except FileNotFoundError:
        print("‚ùå Error: 'demucs' command not found. Please run 'pip install demucs'")
        return {}

    # 3. Locate and Move Files
    # Demucs saves to: output_dir/htdemucs/song_name/vocals.wav

    # Filename without extension (Demucs creates a folder with this name)
    song_name_no_ext = os.path.splitext(filename)[0]
    demucs_output_folder = os.path.join(output_dir, MODEL_NAME, song_name_no_ext)

    saved_paths = {}
    target_names = ['vocals', 'drums', 'bass', 'other']

    if not os.path.exists(demucs_output_folder):
        # Fallback check: Sometimes Demucs behaves differently with spaces or special chars
        # Try searching for any subfolder
        subfolders = [f for f in os.listdir(os.path.join(output_dir, MODEL_NAME)) if
                      os.path.isdir(os.path.join(output_dir, MODEL_NAME, f))]
        if subfolders:
            demucs_output_folder = os.path.join(output_dir, MODEL_NAME, subfolders[0])
        else:
            print(f"‚ùå Could not find output folder: {demucs_output_folder}")
            return {}

    for target in target_names:
        src_path = os.path.join(demucs_output_folder, f"{target}.wav")
        dst_path = os.path.join(output_dir, f"{target}.wav")

        if os.path.exists(src_path):
            # Move file to main output directory
            shutil.move(src_path, dst_path)
            saved_paths[target] = dst_path
            print(f"   ‚úÖ Saved: {target}.wav")

    # Cleanup empty folders generated by Demucs
    try:
        shutil.rmtree(os.path.join(output_dir, MODEL_NAME))
    except:
        pass

    return saved_paths


if __name__ == "__main__":
    current_dir = os.path.dirname(os.path.abspath(__file__))
    project_root = os.path.dirname(current_dir)
    test_song = os.path.join(project_root, "data", "my_songs", "9624 JAZZ CLUB AR.wav")

    if os.path.exists(test_song):
        separate_audio(test_song, output_dir=os.path.join(project_root, "results", "stems"))
    else:
        print(f"‚ùå Test song not found at: {test_song}")